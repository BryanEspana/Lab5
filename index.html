<html>
<head>
</head>
<body>
  <script type="application/javascript">
    //Cargar datos
    function loadMessages() {
    fetch('http://uwu-guate.site:3000/messages')
      .then(response => response.json())
      .then(data => {
        data.forEach(messageData => {
          const MyUserSend = messageData.username === 'Bryan España';
          // Pasamos el objeto completo de messageData a addMessage
          addMessage(messageData, MyUserSend);
          console.log("MessageData: ", messageData);
        });
      })
      .catch(error => console.error('Error al cargar los mensajes:', error));

      
}
document.addEventListener('DOMContentLoaded', function() {
  setInterval(loadMessages, 5000);
  loadMessages(); 
});




document.addEventListener('DOMContentLoaded', loadMessages);

    var UserNameText ="Bryan España"
    document.body.style.margin = "0";
    document.body.style.padding = "0";

    const mainContainer = document.createElement('div');
    mainContainer.style.display = 'flex';
    mainContainer.style.height = '95vh';
    document.body.appendChild(mainContainer);

    const chatListContainer = document.createElement('div');
    chatListContainer.style.width = '20%';
    chatListContainer.style.height = '100vh';
    chatListContainer.style.backgroundColor = 'white';
    chatListContainer.style.overflowY = 'auto';
    chatListContainer.style.borderRight = '2px solid #ccc';
    chatListContainer.style.display = 'flex';
    chatListContainer.style.flexDirection = 'column'; 
    chatListContainer.style.justifyContent = 'space-between'; 

    mainContainer.appendChild(chatListContainer);
    
    
    const userInfoContainer = document.createElement('div');
    userInfoContainer.style.display = 'flex';
    userInfoContainer.style.flexDirection = 'row';
    userInfoContainer.style.alignItems = 'center';
    userInfoContainer.style.padding = '10px 3px';
    userInfoContainer.style.borderBottom = '2px solid #ccc';

    const userImage = document.createElement('img');
    userImage.src = 'user.svg';
    userImage.style.width = '40px';
    userImage.style.height = '40px';
    userImage.style.borderRadius = '50%';
    userImage.style.backgroundColor = 'white'; 
    userImage.style.objectFit = 'fill';
    userImage.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.8)';
    userImage.style.margin = '10px';

    const userName = document.createElement('p');
    userName.textContent = UserNameText;
    userName.style.color = 'inherit';
    userName.style.paddingLeft = '10px';
    userName.style.margin = '0';

    userInfoContainer.appendChild(userImage);
    userInfoContainer.appendChild(userName); 

    const themeToggler = document.createElement('button');
    themeToggler.textContent = 'Tema';
    themeToggler.style.margin = '10px';
    themeToggler.style.width = '100px';
    themeToggler.style.backgroundColor = 'white';
    themeToggler.style.border = 'none';
    themeToggler.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.8)';
    themeToggler.style.padding = '10px 5px';
    themeToggler.style.borderRadius = '5px';
    themeToggler.style.cursor = 'pointer';
    userInfoContainer.appendChild(themeToggler); 

    chatListContainer.appendChild(userInfoContainer);
    
    const chatList = document.createElement('ul');
    chatList.style.listStyle = 'none';
    chatList.style.padding = '0';
    chatList.style.margin = '0';
    chatList.style.overflowY = 'auto';

    const chatAppContainer = document.createElement('div');
    chatAppContainer.style.width = '80%';
    chatAppContainer.style.height = '100vh';
    chatAppContainer.style.display = 'flex';
    chatAppContainer.style.flexDirection = 'column';
    mainContainer.appendChild(chatAppContainer);

    const chatContainer = document.createElement('section');
    const chatHeader = document.createElement('div');
    chatHeader.style.display = 'flex';
    chatHeader.style.justifyContent = 'space-between';
    chatHeader.style.alignItems = 'center';
    chatHeader.style.padding = '10px';
    chatHeader.style.backgroundColor = 'white'; // Color de fondo del encabezado
    chatHeader.style.color = 'white';

    const headerUserImage = document.createElement('img');
    headerUserImage.src = 'user.svg'; // Asegúrate de tener esta imagen o cambia la ruta
    headerUserImage.style.width = '40px';
    headerUserImage.style.height = '40px';
    headerUserImage.style.borderRadius = '50%';
    headerUserImage.style.backgroundColor = 'white'; 
    headerUserImage.style.objectFit = 'fill';
    headerUserImage.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.8)';
    headerUserImage.style.margin = '10px';

    const chatName = document.createElement('span');
    chatName.textContent = 'Chat de Grupo'; // Nombre del chat
    chatName.style.flexGrow = '1';
    chatName.style.color = 'black';

    const infoIcon = document.createElement('img');
    infoIcon.src = 'info.svg'; // Asegúrate de tener este icono o cambia la ruta
    infoIcon.style.width = '24px';
    infoIcon.style.height = '24px';
    infoIcon.style.cursor = 'pointer';

    chatHeader.appendChild(headerUserImage);
    chatHeader.appendChild(chatName);
    chatHeader.appendChild(infoIcon);

    chatAppContainer.appendChild(chatHeader);
    
    chatAppContainer.appendChild(chatContainer);
    chatContainer.style.display = 'flex';
    chatContainer.style.flexDirection = 'column';
    chatContainer.style.height = '100vh';

    
    const messagesContainer = document.createElement('article');
    messagesContainer.style.flexGrow = '1';
    messagesContainer.style.overflowY = 'auto';
    messagesContainer.style.padding = '10px';
    messagesContainer.style.backgroundColor = '#e2e2e2';

    chatContainer.appendChild(messagesContainer);

    const messageInput = document.createElement('input');
    messageInput.type = 'text';
    messageInput.placeholder = 'Escribe un mensaje...';
    messageInput.maxLength = 140;
    
    messageInput.style.margin = '10px';
    messageInput.style.padding = '10px 20px';
    messageInput.style.height = '40px'; 
    messageInput.style.border = 'none';
    messageInput.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.8)';
    messageInput.style.borderRadius = '5px';
    chatContainer.appendChild(messageInput);

    function addMessage(messageData, MyUserSend) {
      const messageContent = messageData.content; // Asegurándose de extraer el contenido del mensaje correctamente.
      const senderUsername = messageData.username; 
      console.log("LOs mysenduser: ", MyUserSend);
      const isImageUrl = (url) => {
        return /\.(jpg|jpeg|png|gif)$/.test(url);
      };
      const messageContainer = document.createElement('div');
      messageContainer.style.display = 'flex';
      messageContainer.style.flexDirection = 'column';
      messageContainer.style.alignItems = 'flex-end'; 
      messageContainer.style.marginBottom = '10px';
      messageContainer.style.alignItems = MyUserSend ? 'flex-end' : 'flex-start';
      

 /*
      if (isImageUrl(messageData)) {
        const image = document.createElement('img');
        image.src = messageData;
        image.style.maxWidth = '200px'; 
        image.style.borderRadius = '5px'; 
        image.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.2)'; 
        messageContainer.appendChild(image);
      } else {

        const messageBubble = document.createElement('div');
        messageBubble.textContent = messageData[2];
        messageBubble.style.backgroundColor = 'white'; 
        messageBubble.style.color = 'black'; 
        messageBubble.style.backgroundColor = MyUserSend ? '#007bff' : '#e2e2e2'; // Azul para enviado, gris para recibido
        messageBubble.style.color = MyUserSend ? 'white' : 'black'; 
        messageBubble.style.padding = '10px';
        messageBubble.style.borderRadius = '15px'; 
        messageBubble.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.2)';
        messageBubble.style.maxWidth = '80%'; 
        messageBubble.style.wordBreak = 'break-word';
        messageContainer.appendChild(messageBubble);
      } */
      const messageBubble = document.createElement('div');
      messageBubble.style.backgroundColor = 'white'; 
      messageBubble.style.color = 'black'; 
      messageBubble.textContent = messageContent; 
      messageBubble.style.padding = '10px';
      messageBubble.style.backgroundColor = MyUserSend ? '#007bff' : '#e2e2e2'; // Azul para enviado, gris para recibido
      messageBubble.style.color = MyUserSend ? 'white' : 'black'; 
      messageBubble.style.borderRadius = '15px'; 
      messageBubble.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.2)';
      messageBubble.style.maxWidth = '80%'; 
      messageBubble.style.wordBreak = 'break-word'; 
      messageContainer.appendChild(messageBubble);

      const senderIndicator = document.createElement('div');
      senderIndicator.textContent = senderUsername;
      senderIndicator.style.fontSize = '0.8rem'; 
      senderIndicator.style.marginRight = '5px'; 

      messageContainer.appendChild(senderIndicator);
      messagesContainer.appendChild(messageContainer);

      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }


    messageInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter' && messageInput.value.trim() !== '') {
        event.preventDefault();

        
        const messageData = {
          username: 'Bryan España', 
          message: messageInput.value.trim()
        };

        fetch('http://uwu-guate.site:3000/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(messageData),
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('La solicitud POST falló');
          }
          return response.json();
        })
        .then(data => {
          console.log('Mensaje enviado:', data);
          addMessage(messageData, true); 
        })
        .catch(error => {
          console.error('Error al enviar el mensaje:', error);
        });

        messageInput.value = '';
      }
    });


    function toggleTheme() {
      const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'light') {
      document.body.style.backgroundColor = '#333';
      document.body.style.color = '#fff';
      chatListContainer.style.backgroundColor = '#333'; 
      
      chatListContainer.style.color = '#fff'; 
      localStorage.setItem('theme', 'dark');
    } else {
      document.body.style.backgroundColor = '#fff';
      document.body.style.color = '#000';
      chatListContainer.style.backgroundColor = '#fff';
      chatListContainer.style.color = '#000'; 
      localStorage.setItem('theme', 'light');
    }
    userInfoContainer.style.transition = 'background-color 1s, color 1s';
    chatListContainer.style.transition = 'background-color 1s, color 1s';
    document.body.style.transition = 'background-color 1s, color 1s';
    messagesContainer.style.transition = 'background-color 1s';
    chatHeader.style.transition = 'background-color 1s, color 1s';
    chatName.style.transition = 'color 1s';

    if (currentTheme === 'light') {
      userInfoContainer.style.backgroundColor = '#333'; 
      userInfoContainer.style.color = '#fff'; 
      chatListContainer.style.backgroundColor = '#333';
      chatListContainer.style.color = '#fff';
      chatHeader.style.backgroundColor = '#575757';
      chatName.style.color = '#fff';
      messagesContainer.style.backgroundColor = '#333333';
      document.body.style.backgroundColor = '#333'; 
      document.body.style.color = '#fff';
    } else {
      userInfoContainer.style.backgroundColor = '#fff';
      userInfoContainer.style.color = '#000'; 
      chatHeader.style.backgroundColor = '#fff';
      chatName.style.color = '#000';
      messagesContainer.style.backgroundColor = '#e2e2e2';
      chatListContainer.style.backgroundColor = '#fff';
      chatListContainer.style.color = '#000'; 
      document.body.style.backgroundColor = '#fff';
      document.body.style.color = '#000';
    }

    }

    themeToggler.addEventListener('click', toggleTheme);

    document.addEventListener('DOMContentLoaded', () => {
      const preferredTheme = localStorage.getItem('theme');
      if (preferredTheme === 'dark') {
        toggleTheme();
      }
    });


  </script>
</body>
</html>
